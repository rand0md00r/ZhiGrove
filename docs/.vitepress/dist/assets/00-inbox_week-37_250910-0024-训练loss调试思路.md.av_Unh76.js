import{_ as i,c as a,o as t,ag as l}from"./chunks/framework.OaOo95RB.js";const g=JSON.parse('{"title":"训练 Loss 调试思路","description":"","frontmatter":{},"headers":[],"relativePath":"00-inbox/week-37/250910-0024-训练loss调试思路.md","filePath":"00-inbox/week-37/250910-0024-训练loss调试思路.md"}'),d={name:"00-inbox/week-37/250910-0024-训练loss调试思路.md"};function h(n,s,e,k,o,p){return t(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="训练-loss-调试思路" tabindex="-1">训练 Loss 调试思路 <a class="header-anchor" href="#训练-loss-调试思路" aria-label="Permalink to &quot;训练 Loss 调试思路&quot;">​</a></h1><blockquote><p>适用于同时包含 <strong>Flow Matching</strong>、<strong>DINO 语义监督</strong>、<strong>KL 正则</strong> 的训练。目标：<strong>验证每个分支是否起作用</strong>，以及<strong>快速定位异常</strong>。</p></blockquote><hr><h2 id="_0-日志与可观测性基线" tabindex="-1">0) 日志与可观测性基线 <a class="header-anchor" href="#_0-日志与可观测性基线" aria-label="Permalink to &quot;0) 日志与可观测性基线&quot;">​</a></h2><p><strong>命名建议</strong></p><ul><li>损失：<code>loss_flow</code> / <code>loss_dino</code> / <code>loss_kl</code>；原始 KL：<code>kl_raw</code></li><li>语义对齐：<code>dino_global</code>（越小越好）</li><li>重参数化统计：<code>z_init/mean</code>、<code>z_init/var</code>（= 采样后的 <code>z_text</code>）</li><li>梯度强度：<code>dbg/grad_flow</code>、<code>dbg/grad_dino_t_head</code>、<code>dbg/grad_mu_head</code>、<code>dbg/grad_logvar_head</code>…</li><li>梯度覆盖：<code>dbg/&amp;lt;tag&gt;_has_grad</code>、<code>dbg/&amp;lt;tag&gt;_trainable</code>（其比值≈<strong>累积步数 GA</strong>）</li><li>参数更新幅度：<code>dbg/update_ratio/&amp;lt;tag&gt;</code></li></ul><p><strong>强制打印技巧</strong></p><ul><li>对任一监控键 <code>k</code> 附加 <strong>影子项</strong>：<code>loss_&amp;lt;k_sanitized&gt; = 0 * &amp;lt;k&gt;</code>，不影响优化，但能被 logger 打印。</li></ul><p><strong>MMEngine 建议</strong></p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">log_processor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> dict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;LogProcessor&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">window_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">by_epoch</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># LoggerHook.interval 设为你的打印节奏（如每 50/100 step）</span></span></code></pre></div><hr><h2 id="_1-关键指标怎么看" tabindex="-1">1) 关键指标怎么看 <a class="header-anchor" href="#_1-关键指标怎么看" aria-label="Permalink to &quot;1) 关键指标怎么看&quot;">​</a></h2><h3 id="_1-1-总览-建议每-50–200-step-打印" tabindex="-1">1.1 总览（建议每 50–200 step 打印） <a class="header-anchor" href="#_1-1-总览-建议每-50–200-step-打印" aria-label="Permalink to &quot;1.1 总览（建议每 50–200 step 打印）&quot;">​</a></h3><table tabindex="0"><thead><tr><th>指标名</th><th>代表含义</th><th>正常趋势</th><th>红旗信号</th><th>处理动作</th></tr></thead><tbody><tr><td><code>loss</code></td><td>总损失</td><td>中/长窗缓慢下降</td><td>长期平台期</td><td>调整 LR/裁剪/权重平衡；下钻子项</td></tr><tr><td><code>loss_flow</code></td><td>FM 主目标</td><td>持续下降</td><td>长期不降</td><td>提 LR/放宽裁剪/减正则；查梯度覆盖</td></tr><tr><td><code>loss_dino</code></td><td>语义监督项</td><td>warmup 期占比小，逐步起量</td><td>早期占比过高或抖动大</td><td>降 <code>dino_alpha</code>、拉长 warmup</td></tr><tr><td><code>loss_kl</code> / <code>kl_raw</code></td><td>先验约束</td><td><code>kl_raw</code> 缓慢收敛</td><td>持续增大</td><td>增 KL 权重、约束 <code>logvar</code></td></tr><tr><td><code>dino_global</code></td><td>DINO 对齐度</td><td><strong>下降</strong>（越小越好）</td><td>不降反升</td><td>降 <code>alpha</code>/延长 warmup/关局部</td></tr><tr><td><code>z_init/mean</code></td><td>采样均值</td><td>近 0 小幅波动</td><td>|mean| &gt; 0.1</td><td>mu/logvar 后加 LN/居中化</td></tr><tr><td><code>z_init/var</code></td><td>采样方差</td><td>收敛到 ≈0.8–1.0</td><td>&lt;0.3 或 &gt;1.5</td><td>调 KL 权重、clamp <code>logvar</code></td></tr><tr><td><code>dbg/grad_flow</code></td><td>Flow 梯度范数</td><td>随 <code>loss_flow</code> 下降而变小</td><td>长期≈0 或爆高</td><td>调 LR/裁剪/数值稳定性</td></tr><tr><td><code>dbg/flow_has_grad</code> / <code>dbg/flow_trainable</code></td><td>梯度覆盖</td><td>比值≈<strong>GA</strong></td><td>偏离 &gt;±10% 或 =0</td><td>校准 GA/no_sync/flush 时机</td></tr><tr><td><code>dbg/grad_dino_t_head</code></td><td>DINO 梯度</td><td>随 warmup 逐步变大</td><td>早期过大</td><td>降 <code>alpha</code>、拉长 warmup</td></tr><tr><td><code>dbg/update_ratio/&amp;lt;tag&gt;</code></td><td>参数步长占比</td><td>稳定非零</td><td>长期≈0</td><td>提 LR/减正则/查冻结</td></tr></tbody></table><blockquote><p><strong>推进性的判定</strong>：当 <code>loss_flow ↓</code>、<code>dbg/grad_flow &gt; 0</code>、<code>has_grad/trainable ≈ GA</code> 同时成立，说明 Flow 分支确实在学习。</p></blockquote><hr><h2 id="_2-三类-loss-的-有效性验证" tabindex="-1">2) 三类 Loss 的“有效性验证” <a class="header-anchor" href="#_2-三类-loss-的-有效性验证" aria-label="Permalink to &quot;2) 三类 Loss 的“有效性验证”&quot;">​</a></h2><h3 id="_2-1-flow-matching" tabindex="-1">2.1 Flow Matching <a class="header-anchor" href="#_2-1-flow-matching" aria-label="Permalink to &quot;2.1 Flow Matching&quot;">​</a></h3><ul><li><strong>主观察</strong>：<code>loss_flow</code> 持续下降；<code>dbg/grad_flow</code> 非零且平滑收敛；<code>has_grad/trainable ≈ GA</code>。</li><li><strong>辅助</strong>：对比 <code>‖z_text‖</code> 与目标 <code>‖x1‖</code> 的尺度，避免失配导致梯度极小/极大。</li><li><strong>异常修复</strong><ul><li>不降且梯度很小：提 LR、放宽裁剪、减弱其它正则。</li><li>不降且梯度很大：降 LR、加裁剪、检查归一化/数值稳定。</li></ul></li></ul><h3 id="_2-2-dino-语义监督" tabindex="-1">2.2 DINO 语义监督 <a class="header-anchor" href="#_2-2-dino-语义监督" aria-label="Permalink to &quot;2.2 DINO 语义监督&quot;">​</a></h3><ul><li><strong>主观察</strong>：warmup 期间 <code>loss_dino</code> 占比小；<code>dbg/grad_dino_t_head</code> 随步增大；<code>dino_global</code> 缓慢下降。</li><li><strong>对照</strong>：临时关闭 DINO 或只保留 global 分支，确认不会干扰 FM。</li><li><strong>异常修复</strong>：降低 <code>dino_alpha</code>、延长 warmup、关闭局部 patch 对齐。</li></ul><h3 id="_2-3-kl-正则" tabindex="-1">2.3 KL 正则 <a class="header-anchor" href="#_2-3-kl-正则" aria-label="Permalink to &quot;2.3 KL 正则&quot;">​</a></h3><ul><li><strong>主观察</strong>：<code>kl_raw</code> 缓慢收敛；<code>z_init/mean ≈ 0</code>，<code>z_init/var → 0.8–1.0</code>。</li><li><strong>异常修复</strong><ul><li><code>kl_raw ↑</code> 且 <code>z_init/var ↑</code>：增 KL 权重、clamp <code>logvar</code>、mu/logvar 头后加 LN。</li><li>方差坍缩：降低 KL 权重或做 β-anneal。</li></ul></li></ul><hr><h2 id="_3-梯度监控-ddp-zero-友好-无额外-backward" tabindex="-1">3) 梯度监控（DDP/ZeRO 友好，无额外 backward） <a class="header-anchor" href="#_3-梯度监控-ddp-zero-友好-无额外-backward" aria-label="Permalink to &quot;3) 梯度监控（DDP/ZeRO 友好，无额外 backward）&quot;">​</a></h2><p><strong>做法</strong>：给关键模块参数注册 <code>p.register_hook</code>，在<strong>真实 backward</strong>期间累加 <code>g.pow(2).sum()</code> 与计数；<strong>下一步</strong>把快照写入日志（一步延迟，零冲突）。</p><ul><li>记录：<code>dbg/grad_&amp;lt;tag&gt;</code>、<code>dbg/&amp;lt;tag&gt;_has_grad</code>、<code>dbg/&amp;lt;tag&gt;_trainable</code></li><li>保障打印：为每个 <code>dbg/*</code> 加 <code>loss_dbg_* = 0 * dbg/*</code></li></ul><p><strong>为何不用 <code>autograd.grad</code></strong>：与 reentrant checkpoint 不兼容；ZeRO/DDP 不支持同参多次规约，易触发 <em>already been reduced</em>。</p><hr><h2 id="_4-参数-更新幅度-step-ratio" tabindex="-1">4) 参数“更新幅度”（Step Ratio） <a class="header-anchor" href="#_4-参数-更新幅度-step-ratio" aria-label="Permalink to &quot;4) 参数“更新幅度”（Step Ratio）&quot;">​</a></h2><ul><li>定义：<code>update_ratio = ||Δθ|| / (||θ|| + ε)</code>（模块内 L2 汇总）</li><li>作用：验证“梯度×LR”是否让参数移动；长期≈0 代表学不动（LR 太小/正则过大/被裁剪/被冻结）</li><li>记录：<code>dbg/update_ratio/&amp;lt;tag&gt;</code>（每步对比上一快照）</li></ul><hr><h2 id="_5-与分布式-checkpoint-的注意" tabindex="-1">5) 与分布式 &amp; Checkpoint 的注意 <a class="header-anchor" href="#_5-与分布式-checkpoint-的注意" aria-label="Permalink to &quot;5) 与分布式 &amp; Checkpoint 的注意&quot;">​</a></h2><ul><li>尽量将所有 <code>checkpoint(...)</code> 设为 <code>use_reentrant=False</code>。</li><li>如果做不到，<strong>只用 hook 监控</strong>，不要做额外 backward。</li><li>出现 <em>already been reduced</em>：说明同一迭代做了多次 backward → 去掉监控用 backward。</li></ul><hr><h2 id="_6-常见问题速查" tabindex="-1">6) 常见问题速查 <a class="header-anchor" href="#_6-常见问题速查" aria-label="Permalink to &quot;6) 常见问题速查&quot;">​</a></h2><table tabindex="0"><thead><tr><th>症状</th><th>可能原因</th><th>快速修复</th></tr></thead><tbody><tr><td><code>loss_flow</code> 平台且 <code>grad_flow</code> 很小</td><td>LR 小 / 裁剪或正则过强</td><td>提 LR / 放宽裁剪 / 减正则</td></tr><tr><td><code>loss_flow</code> 抖动大且 <code>grad_flow</code> 爆高</td><td>LR 高 / 数值不稳</td><td>降 LR / 加裁剪 / 加 LN</td></tr><tr><td><code>dino_global</code> 不降</td><td>语义分支过强或 warmup 失效</td><td>降 <code>alpha</code> / 延长 warmup / 关局部</td></tr><tr><td><code>z_init/var ↑</code> + <code>kl_raw ↑</code></td><td>KL 太弱</td><td>增 β、clamp <code>logvar</code>、加 LN</td></tr><tr><td><code>has_grad/trainable</code> ≠ GA</td><td>累积/flush/no_sync 不一致</td><td>校准 GA 与 flush 时机</td></tr><tr><td>日志缺少 <code>dbg/*</code></td><td>无影子 <code>loss_*</code></td><td>为每个监控键加 0 权重 <code>loss_*</code></td></tr></tbody></table><hr><h2 id="_7-建议阈值-可做告警" tabindex="-1">7) 建议阈值（可做告警） <a class="header-anchor" href="#_7-建议阈值-可做告警" aria-label="Permalink to &quot;7) 建议阈值（可做告警）&quot;">​</a></h2><ul><li><code>has_grad/trainable</code> 偏离 GA <strong>&gt; ±10%</strong> 连续 100 step</li><li><code>dbg/grad_flow &lt; 1e-2</code> 且 <code>loss_flow</code> 连续 100 step 不降</li><li><code>dino_global</code> 在 warmup 中段以后 <strong>200 step 不降</strong></li><li><code>|z_init/mean| &gt; 0.1</code> 或 <code>z_init/var &lt; 0.3 / &gt; 1.5</code> 连续 200 step</li><li><code>kl_raw</code> 连续 200 step 上升</li></ul><hr><h2 id="_8-最小监控清单-quick-start" tabindex="-1">8) 最小监控清单（Quick Start） <a class="header-anchor" href="#_8-最小监控清单-quick-start" aria-label="Permalink to &quot;8) 最小监控清单（Quick Start）&quot;">​</a></h2><ol><li>损失：<code>loss_flow</code>、<code>loss_dino</code>、<code>loss_kl</code>、<code>kl_raw</code>、<code>dino_global</code></li><li>z 分布：<code>z_init/mean</code>、<code>z_init/var</code></li><li>梯度（hook）：<code>dbg/grad_flow</code>、<code>dbg/flow_has_grad</code>、<code>dbg/flow_trainable</code>、<code>dbg/grad_dino_t_head</code></li><li>更新幅度：<code>dbg/update_ratio/flow</code>（及其它关键模块）</li><li>打印保障：为每个键加 0 权重 <code>loss_*</code> 影子项</li></ol><hr><h2 id="_9-参考代码骨架-监控思路" tabindex="-1">9) 参考代码骨架（监控思路） <a class="header-anchor" href="#_9-参考代码骨架-监控思路" aria-label="Permalink to &quot;9) 参考代码骨架（监控思路）&quot;">​</a></h2><blockquote><p>仅示意：<strong>hook 累积 → 下一步 flush</strong>；每个写入附带 0 权重 <code>loss_*</code> 影子项。</p></blockquote><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1) 安装参数 hook（在 __init__）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _install_grad_taps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> add_hooks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mod, tag):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">is</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._trainable_counts[tag] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mod.parameters():</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> not</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p.requires_grad: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">continue</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._trainable_counts[tag] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _hook</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(g, _tag</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tag):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                st </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._grad_acc.setdefault(_tag, {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;sq&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;cnt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                st[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;sq&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> float</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(g.detach().float().pow(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).sum().item())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                st[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;cnt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            p.register_hook(_hook)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    add_hooks(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.fm_transformers, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;flow&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    add_hooks(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.dino_t_head, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;dino_t_head&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    add_hooks(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.mu_head, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;mu_head&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    add_hooks(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.logvar_head, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;logvar_head&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2) 训练步尾：把“上一轮”统计写入 ret；本轮统计滚动成“上一轮”</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _flush_grad_stats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, ret: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">dict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> math, torch</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tag, st </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._last_grad_stats.items():</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        gn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> math.sqrt(st.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;sq&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        got </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> st.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;cnt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        tot </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._trainable_counts.get(tag, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ret[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;dbg/grad_</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tag</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.tensor(gn, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.device)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ret[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;dbg/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tag</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_has_grad&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.tensor(got, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.device)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ret[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;dbg/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tag</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_trainable&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.tensor(tot, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.device)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ret[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;loss_dbg_grad_</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tag</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ret[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;dbg/grad_</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tag</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.0</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 影子项</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._last_grad_stats </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._grad_acc</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._grad_acc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}</span></span></code></pre></div><hr><h2 id="_10-小结" tabindex="-1">10) 小结 <a class="header-anchor" href="#_10-小结" aria-label="Permalink to &quot;10) 小结&quot;">​</a></h2><ul><li><strong>趋势优先</strong>：<code>loss_flow↓</code>、<code>dino_global↓</code>、<code>kl_raw</code> 稳定；<code>z_init</code> 均值≈0、方差≈1。</li><li><strong>梯度证据</strong>：强度非零、覆盖≈GA、<code>update_ratio</code> 非零。</li><li><strong>定位方法</strong>：对照实验 + 阈值告警 + hook 梯度，快速判断“哪个分支不工作 / 过强 / 过弱”，精准调参。</li></ul>`,50)])])}const c=i(d,[["render",h]]);export{g as __pageData,c as default};
