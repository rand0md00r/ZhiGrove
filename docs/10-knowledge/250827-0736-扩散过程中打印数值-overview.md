---
title: 扩散过程中打印数值
created: 2025-09-07 17:02
updated: 2025-09-07
origin: week-35
type: knowledge
status: draft
tags: [flow_matching, debugging, diffusion, logging]
links: []
---

## TL;DR（≤3点）
- 通过在 **Flow Matching** 扩散过程中打印中间变量，检查数值范围与时间步是否合理；
- 核心关注 `|x|`、`|v|` 和 `dt` 的稳定性，发现数值发散或异常收敛可快速定位问题；
- 建议在调试阶段开启 **fp32** 精度并增加 `num_steps` 以提升可观测性。

## What（是什么）
- 在 **Flow Matching** 扩散推导过程中，通过打印关键中间变量来调试训练稳定性。
- 主要监控：
  - `|x|` → 扩散状态向量的均值绝对值
  - `|v|` → 速度场或梯度向量的均值绝对值
  - `dt` → 每步积分步长

## Why（为什么这么做/何时使用）
- Flow Matching 的数值积分对初始条件、步长和数据尺度非常敏感；
- 如果 `|x|` 或 `|v|` 持续发散，说明可能：
  1. 学习率过大导致梯度爆炸
  2. dt 步长不合理
  3. 初始分布标准化不一致
- 通过打印，可以**快速判断问题来源**，缩短调参时间

## How（最小复现配方，≤5步）
1. 在模型代码中插入打印：
    ```python
    print(f"step{k}: |x|={x.abs().mean():.4f}, |v|={v.abs().mean():.4f}, dt={float(dt[k]):.4f}")
    ```
2. 使用 **fp32** 精度进行调试，避免 fp16 混合精度隐藏溢出问题。
3. 将 `num_steps` 增加到 100，检查长期数值稳定性。
4. 关注日志中 `|x|`、`|v|`、`dt` 是否呈对称收敛或稳定趋势。
5. 若出现异常，定位对应 `step_k`，检查梯度、loss 和参数更新逻辑。

## Gotchas（坑点与边界）
- **fp16 下梯度可能被裁剪或 NaN 隐藏** → 调试请切换到 fp32。
- **dt 非线性分布**：扩散过程步长并非均匀，建议打印确认。
- **不同 batch 会影响 |x| 量级** → 建议对样本维度求均值，避免被单个异常样本放大。
- **tdp_torch 警告**：如提示使用较慢实现，可先忽略，对数值无影响。


## Raw Notes

``` python
print(f"step{k}: |x|={x.abs().mean():.4f}, |v|={v.abs().mean():.4f}, dt={float(dt[k]):.4f}")
``` 

``` bash

step0: |x|=6.1875, |v|=0.4531, dt=0.1532
step1: |x|=6.1875, |v|=0.4531, dt=0.0555
step2: |x|=6.1875, |v|=0.4531, dt=0.0446
step3: |x|=6.1875, |v|=0.4531, dt=0.0394
step4: |x|=6.1875, |v|=0.4531, dt=0.0363
step5: |x|=6.1875, |v|=0.4531, dt=0.0343
step6: |x|=6.1875, |v|=0.4531, dt=0.0330
step7: |x|=6.1875, |v|=0.4531, dt=0.0322
step8: |x|=6.1875, |v|=0.4531, dt=0.0316
step9: |x|=6.1875, |v|=0.4531, dt=0.0314
step10: |x|=6.1875, |v|=0.4531, dt=0.0314
step11: |x|=6.1875, |v|=0.4531, dt=0.0316
step12: |x|=6.1875, |v|=0.4531, dt=0.0322
step13: |x|=6.1875, |v|=0.4531, dt=0.0330
step14: |x|=6.1875, |v|=0.4531, dt=0.0343
step15: |x|=6.1875, |v|=0.4531, dt=0.0363
step16: |x|=6.1875, |v|=0.4531, dt=0.0394
step17: |x|=6.1875, |v|=0.4531, dt=0.0446
step18: |x|=6.2188, |v|=0.4531, dt=0.0555
step19: |x|=6.2188, |v|=0.4531, dt=0.1532
1it [00:12, 12.37s/it]/vepfs/group03/wyq/ug_uni/CrossUni-do/src/models/diffusion/sigmoid_kernel.py:30: UserWarning: Using slower tdp_torch implementation for a tensor with shape torch.Size([1024])
  warnings.warn(f'Using slower tdp_torch implementation for a tensor with shape {param0.shape}')
/vepfs/group03/wyq/ug_uni/CrossUni-do/src/models/diffusion/sigmoid_kernel.py:30: UserWarning: Using slower tdp_torch implementation for a tensor with shape torch.Size([67584])
  warnings.warn(f'Using slower tdp_torch implementation for a tensor with shape {param0.shape}')
/vepfs/group03/wyq/ug_uni/CrossUni-do/src/models/diffusion/sigmoid_kernel.py:30: UserWarning: Using slower tdp_torch implementation for a tensor with shape torch.Size([512])
  warnings.warn(f'Using slower tdp_torch implementation for a tensor with shape {param0.shape}')
/usr/local/lib/python3.10/site-packages/torch/_dynamo/eval_frame.py:745: UserWarning: torch.utils.checkpoint: the use_reentrant parameter should be passed explicitly. In version 2.5 we will raise an exception if use_reentrant is not passed. use_reentrant=False is recommended, but if you need to preserve the current default behavior, you can pass use_reentrant=True. Refer to docs for more details on the differences between the two variants.
  return fn(*args, **kwargs)
/usr/local/lib/python3.10/site-packages/torch/utils/checkpoint.py:87: UserWarning: None of the inputs have requires_grad=True. Gradients will be None
  warnings.warn(
step0: |x|=6.2188, |v|=0.4531, dt=0.1532
step1: |x|=6.2188, |v|=0.4531, dt=0.0555
step2: |x|=6.2188, |v|=0.4531, dt=0.0446
step3: |x|=6.2188, |v|=0.4531, dt=0.0394
step4: |x|=6.2188, |v|=0.4531, dt=0.0363
step5: |x|=6.2188, |v|=0.4531, dt=0.0343
step6: |x|=6.2188, |v|=0.4531, dt=0.0330
step7: |x|=6.2188, |v|=0.4531, dt=0.0322
step8: |x|=6.2188, |v|=0.4531, dt=0.0316
step9: |x|=6.2188, |v|=0.4531, dt=0.0314
step10: |x|=6.2188, |v|=0.4531, dt=0.0314
step11: |x|=6.2188, |v|=0.4531, dt=0.0316
step12: |x|=6.2188, |v|=0.4531, dt=0.0322
step13: |x|=6.2188, |v|=0.4531, dt=0.0330
step14: |x|=6.2188, |v|=0.4531, dt=0.0343
step15: |x|=6.2188, |v|=0.4531, dt=0.0363
step16: |x|=6.2188, |v|=0.4531, dt=0.0394
step17: |x|=6.2188, |v|=0.4531, dt=0.0446
step18: |x|=6.2188, |v|=0.4531, dt=0.0555
step19: |x|=6.2188, |v|=0.4531, dt=0.1532
2it [00:18,  8.48s/it]/vepfs/group03/wyq/ug_uni/CrossUni-do/src/models/diffusion/sigmoid_kernel.py:30: UserWarning: Using slower tdp_torch implementation for a tensor with shape torch.Size([1024])
  warnings.warn(f'Using slower tdp_torch implementation for a tensor with shape {param0.shape}')
/vepfs/group03/wyq/ug_uni/CrossUni-do/src/models/diffusion/sigmoid_kernel.py:30: UserWarning: Using slower tdp_torch implementation for a tensor with shape torch.Size([67584])
  warnings.warn(f'Using slower tdp_torch implementation for a tensor with shape {param0.shape}')
/vepfs/group03/wyq/ug_uni/CrossUni-do/src/models/diffusion/sigmoid_kernel.py:30: UserWarning: Using slower tdp_torch implementation for a tensor with shape torch.Size([512])
  warnings.warn(f'Using slower tdp_torch implementation for a tensor with shape {param0.shape}')
/usr/local/lib/python3.10/site-packages/torch/_dynamo/eval_frame.py:745: UserWarning: torch.utils.checkpoint: the use_reentrant parameter should be passed explicitly. In version 2.5 we will raise an exception if use_reentrant is not passed. use_reentrant=False is recommended, but if you need to preserve the current default behavior, you can pass use_reentrant=True. Refer to docs for more details on the differences between the two variants.
  return fn(*args, **kwargs)
/usr/local/lib/python3.10/site-packages/torch/utils/checkpoint.py:87: UserWarning: None of the inputs have requires_grad=True. Gradients will be None
  warnings.warn(
step0: |x|=6.1875, |v|=0.4531, dt=0.1532
step1: |x|=6.1875, |v|=0.4531, dt=0.0555
step2: |x|=6.1875, |v|=0.4531, dt=0.0446
step3: |x|=6.1875, |v|=0.4531, dt=0.0394
step4: |x|=6.1875, |v|=0.4531, dt=0.0363
step5: |x|=6.1875, |v|=0.4531, dt=0.0343
step6: |x|=6.1875, |v|=0.4531, dt=0.0330
step7: |x|=6.1875, |v|=0.4531, dt=0.0322
step8: |x|=6.1875, |v|=0.4531, dt=0.0316
step9: |x|=6.1875, |v|=0.4531, dt=0.0314
step10: |x|=6.1875, |v|=0.4531, dt=0.0314
step11: |x|=6.1875, |v|=0.4531, dt=0.0316
step12: |x|=6.1875, |v|=0.4531, dt=0.0322
step13: |x|=6.2188, |v|=0.4531, dt=0.0330
step14: |x|=6.2188, |v|=0.4531, dt=0.0343
step15: |x|=6.2188, |v|=0.4531, dt=0.0363
step16: |x|=6.2188, |v|=0.4531, dt=0.0394
step17: |x|=6.2188, |v|=0.4531, dt=0.0446
step18: |x|=6.2188, |v|=0.4531, dt=0.0555
step19: |x|=6.2188, |v|=0.4531, dt=0.1532

```


过程量改为fp32, num_step改为100：
``` bash
3it [00:42, 13.40s/it]step0: |x|=0.7889, |v|=0.4671, dt=0.0804
step1: |x|=0.7900, |v|=0.4649, dt=0.0247
step2: |x|=0.7908, |v|=0.4644, dt=0.0186
step3: |x|=0.7914, |v|=0.4639, dt=0.0157
step4: |x|=0.7920, |v|=0.4637, dt=0.0138
step5: |x|=0.7926, |v|=0.4635, dt=0.0126
step6: |x|=0.7931, |v|=0.4633, dt=0.0117
step7: |x|=0.7937, |v|=0.4632, dt=0.0109
step8: |x|=0.7942, |v|=0.4629, dt=0.0104
step9: |x|=0.7948, |v|=0.4628, dt=0.0099
step10: |x|=0.7953, |v|=0.4627, dt=0.0095
step11: |x|=0.7959, |v|=0.4625, dt=0.0092
step12: |x|=0.7964, |v|=0.4624, dt=0.0089
step13: |x|=0.7970, |v|=0.4623, dt=0.0086
step14: |x|=0.7975, |v|=0.4622, dt=0.0084
step15: |x|=0.7981, |v|=0.4622, dt=0.0082
step16: |x|=0.7987, |v|=0.4620, dt=0.0080
step17: |x|=0.7993, |v|=0.4619, dt=0.0079
step18: |x|=0.7998, |v|=0.4617, dt=0.0077
step19: |x|=0.8004, |v|=0.4618, dt=0.0076
step20: |x|=0.8010, |v|=0.4617, dt=0.0075
step21: |x|=0.8016, |v|=0.4616, dt=0.0074
step22: |x|=0.8021, |v|=0.4616, dt=0.0073
step23: |x|=0.8027, |v|=0.4614, dt=0.0072
step24: |x|=0.8033, |v|=0.4613, dt=0.0071
step25: |x|=0.8039, |v|=0.4613, dt=0.0070
step26: |x|=0.8045, |v|=0.4612, dt=0.0069
step27: |x|=0.8051, |v|=0.4612, dt=0.0069
step28: |x|=0.8057, |v|=0.4611, dt=0.0068
step29: |x|=0.8063, |v|=0.4608, dt=0.0067
step30: |x|=0.8070, |v|=0.4609, dt=0.0067
step31: |x|=0.8076, |v|=0.4608, dt=0.0066
step32: |x|=0.8082, |v|=0.4607, dt=0.0066
step33: |x|=0.8088, |v|=0.4607, dt=0.0066
step34: |x|=0.8095, |v|=0.4606, dt=0.0065
step35: |x|=0.8101, |v|=0.4605, dt=0.0065
step36: |x|=0.8108, |v|=0.4604, dt=0.0065
step37: |x|=0.8114, |v|=0.4604, dt=0.0064
step38: |x|=0.8121, |v|=0.4603, dt=0.0064
step39: |x|=0.8128, |v|=0.4601, dt=0.0064
step40: |x|=0.8134, |v|=0.4601, dt=0.0064
step41: |x|=0.8141, |v|=0.4599, dt=0.0063
step42: |x|=0.8148, |v|=0.4599, dt=0.0063
step43: |x|=0.8155, |v|=0.4598, dt=0.0063
step44: |x|=0.8162, |v|=0.4597, dt=0.0063
step45: |x|=0.8169, |v|=0.4596, dt=0.0063
step46: |x|=0.8176, |v|=0.4595, dt=0.0063
step47: |x|=0.8183, |v|=0.4593, dt=0.0063
step48: |x|=0.8190, |v|=0.4593, dt=0.0063
step49: |x|=0.8198, |v|=0.4591, dt=0.0063
step50: |x|=0.8205, |v|=0.4590, dt=0.0063
step51: |x|=0.8213, |v|=0.4589, dt=0.0063
step52: |x|=0.8220, |v|=0.4589, dt=0.0063
step53: |x|=0.8228, |v|=0.4587, dt=0.0063
step54: |x|=0.8236, |v|=0.4585, dt=0.0063
step55: |x|=0.8244, |v|=0.4583, dt=0.0063
step56: |x|=0.8252, |v|=0.4582, dt=0.0063
step57: |x|=0.8259, |v|=0.4581, dt=0.0063
step58: |x|=0.8268, |v|=0.4579, dt=0.0063
step59: |x|=0.8276, |v|=0.4578, dt=0.0064
step60: |x|=0.8284, |v|=0.4576, dt=0.0064
step61: |x|=0.8292, |v|=0.4574, dt=0.0064
step62: |x|=0.8301, |v|=0.4573, dt=0.0064
step63: |x|=0.8310, |v|=0.4572, dt=0.0065
step64: |x|=0.8318, |v|=0.4570, dt=0.0065
step65: |x|=0.8327, |v|=0.4568, dt=0.0065
step66: |x|=0.8336, |v|=0.4567, dt=0.0066
step67: |x|=0.8345, |v|=0.4565, dt=0.0066
step68: |x|=0.8354, |v|=0.4564, dt=0.0066
step69: |x|=0.8364, |v|=0.4561, dt=0.0067
step70: |x|=0.8373, |v|=0.4560, dt=0.0067
step71: |x|=0.8383, |v|=0.4558, dt=0.0068
step72: |x|=0.8393, |v|=0.4557, dt=0.0069
step73: |x|=0.8403, |v|=0.4554, dt=0.0069
step74: |x|=0.8413, |v|=0.4552, dt=0.0070
step75: |x|=0.8423, |v|=0.4550, dt=0.0071
step76: |x|=0.8434, |v|=0.4548, dt=0.0072
step77: |x|=0.8445, |v|=0.4547, dt=0.0073
step78: |x|=0.8456, |v|=0.4544, dt=0.0074
step79: |x|=0.8467, |v|=0.4542, dt=0.0075
step80: |x|=0.8478, |v|=0.4540, dt=0.0076
step81: |x|=0.8490, |v|=0.4538, dt=0.0077
step82: |x|=0.8502, |v|=0.4535, dt=0.0079
step83: |x|=0.8514, |v|=0.4533, dt=0.0080
step84: |x|=0.8527, |v|=0.4531, dt=0.0082
step85: |x|=0.8540, |v|=0.4528, dt=0.0084
step86: |x|=0.8553, |v|=0.4526, dt=0.0086
step87: |x|=0.8567, |v|=0.4525, dt=0.0089
step88: |x|=0.8582, |v|=0.4522, dt=0.0092
step89: |x|=0.8597, |v|=0.4519, dt=0.0095
step90: |x|=0.8613, |v|=0.4516, dt=0.0099
step91: |x|=0.8629, |v|=0.4512, dt=0.0104
step92: |x|=0.8647, |v|=0.4509, dt=0.0109
step93: |x|=0.8665, |v|=0.4507, dt=0.0117
step94: |x|=0.8686, |v|=0.4503, dt=0.0126
step95: |x|=0.8708, |v|=0.4499, dt=0.0138
step96: |x|=0.8732, |v|=0.4495, dt=0.0157
step97: |x|=0.8760, |v|=0.4491, dt=0.0186
step98: |x|=0.8793, |v|=0.4485, dt=0.0247
step99: |x|=0.8839, |v|=0.4477, dt=0.0804
4it [00:54, 12.85s/it]step0: |x|=0.7891, |v|=0.4649, dt=0.0804
step1: |x|=0.7897, |v|=0.4635, dt=0.0247
step2: |x|=0.7902, |v|=0.4632, dt=0.0186
step3: |x|=0.7907, |v|=0.4631, dt=0.0157
step4: |x|=0.7911, |v|=0.4630, dt=0.0138
step5: |x|=0.7916, |v|=0.4629, dt=0.0126
step6: |x|=0.7921, |v|=0.4628, dt=0.0117
step7: |x|=0.7926, |v|=0.4628, dt=0.0109
step8: |x|=0.7930, |v|=0.4627, dt=0.0104
step9: |x|=0.7935, |v|=0.4627, dt=0.0099
step10: |x|=0.7940, |v|=0.4627, dt=0.0095
step11: |x|=0.7945, |v|=0.4628, dt=0.0092
step12: |x|=0.7950, |v|=0.4627, dt=0.0089
step13: |x|=0.7955, |v|=0.4627, dt=0.0086
step14: |x|=0.7960, |v|=0.4627, dt=0.0084
step15: |x|=0.7965, |v|=0.4627, dt=0.0082
step16: |x|=0.7970, |v|=0.4629, dt=0.0080
step17: |x|=0.7975, |v|=0.4629, dt=0.0079
step18: |x|=0.7980, |v|=0.4629, dt=0.0077
step19: |x|=0.7985, |v|=0.4629, dt=0.0076
step20: |x|=0.7990, |v|=0.4629, dt=0.0075
step21: |x|=0.7995, |v|=0.4629, dt=0.0074
step22: |x|=0.8000, |v|=0.4628, dt=0.0073
step23: |x|=0.8006, |v|=0.4629, dt=0.0072
step24: |x|=0.8011, |v|=0.4628, dt=0.0071
step25: |x|=0.8016, |v|=0.4628, dt=0.0070
step26: |x|=0.8022, |v|=0.4627, dt=0.0069
step27: |x|=0.8027, |v|=0.4627, dt=0.0069
step28: |x|=0.8033, |v|=0.4627, dt=0.0068
step29: |x|=0.8039, |v|=0.4626, dt=0.0067
step30: |x|=0.8045, |v|=0.4627, dt=0.0067
step31: |x|=0.8050, |v|=0.4627, dt=0.0066
step32: |x|=0.8056, |v|=0.4626, dt=0.0066
step33: |x|=0.8062, |v|=0.4626, dt=0.0066
step34: |x|=0.8068, |v|=0.4626, dt=0.0065
step35: |x|=0.8074, |v|=0.4626, dt=0.0065
step36: |x|=0.8080, |v|=0.4625, dt=0.0065
step37: |x|=0.8087, |v|=0.4625, dt=0.0064
step38: |x|=0.8093, |v|=0.4624, dt=0.0064
step39: |x|=0.8099, |v|=0.4624, dt=0.0064
step40: |x|=0.8106, |v|=0.4623, dt=0.0064
step41: |x|=0.8112, |v|=0.4622, dt=0.0063
step42: |x|=0.8119, |v|=0.4623, dt=0.0063
step43: |x|=0.8125, |v|=0.4622, dt=0.0063
step44: |x|=0.8132, |v|=0.4622, dt=0.0063
step45: |x|=0.8139, |v|=0.4621, dt=0.0063
step46: |x|=0.8146, |v|=0.4620, dt=0.0063
step47: |x|=0.8153, |v|=0.4619, dt=0.0063
step48: |x|=0.8160, |v|=0.4619, dt=0.0063
step49: |x|=0.8167, |v|=0.4618, dt=0.0063
step50: |x|=0.8175, |v|=0.4617, dt=0.0063
step51: |x|=0.8182, |v|=0.4616, dt=0.0063
step52: |x|=0.8189, |v|=0.4616, dt=0.0063
step53: |x|=0.8197, |v|=0.4616, dt=0.0063
step54: |x|=0.8204, |v|=0.4614, dt=0.0063
step55: |x|=0.8212, |v|=0.4613, dt=0.0063
step56: |x|=0.8220, |v|=0.4612, dt=0.0063
step57: |x|=0.8228, |v|=0.4610, dt=0.0063
step58: |x|=0.8235, |v|=0.4610, dt=0.0063
step59: |x|=0.8243, |v|=0.4607, dt=0.0064
step60: |x|=0.8252, |v|=0.4607, dt=0.0064
step61: |x|=0.8260, |v|=0.4606, dt=0.0064
step62: |x|=0.8268, |v|=0.4604, dt=0.0064
step63: |x|=0.8277, |v|=0.4602, dt=0.0065
step64: |x|=0.8285, |v|=0.4601, dt=0.0065
step65: |x|=0.8294, |v|=0.4599, dt=0.0065
step66: |x|=0.8303, |v|=0.4597, dt=0.0066
step67: |x|=0.8312, |v|=0.4597, dt=0.0066
step68: |x|=0.8321, |v|=0.4594, dt=0.0066
step69: |x|=0.8330, |v|=0.4592, dt=0.0067
step70: |x|=0.8339, |v|=0.4591, dt=0.0067
step71: |x|=0.8349, |v|=0.4588, dt=0.0068
step72: |x|=0.8358, |v|=0.4587, dt=0.0069
step73: |x|=0.8368, |v|=0.4585, dt=0.0069
step74: |x|=0.8378, |v|=0.4582, dt=0.0070
step75: |x|=0.8388, |v|=0.4580, dt=0.0071
step76: |x|=0.8399, |v|=0.4579, dt=0.0072
step77: |x|=0.8409, |v|=0.4576, dt=0.0073
step78: |x|=0.8420, |v|=0.4574, dt=0.0074
step79: |x|=0.8431, |v|=0.4571, dt=0.0075
step80: |x|=0.8442, |v|=0.4569, dt=0.0076
step81: |x|=0.8454, |v|=0.4566, dt=0.0077
step82: |x|=0.8466, |v|=0.4563, dt=0.0079
step83: |x|=0.8478, |v|=0.4560, dt=0.0080
step84: |x|=0.8491, |v|=0.4558, dt=0.0082
step85: |x|=0.8504, |v|=0.4554, dt=0.0084
step86: |x|=0.8517, |v|=0.4551, dt=0.0086
step87: |x|=0.8531, |v|=0.4548, dt=0.0089
step88: |x|=0.8545, |v|=0.4545, dt=0.0092
step89: |x|=0.8560, |v|=0.4542, dt=0.0095
step90: |x|=0.8576, |v|=0.4538, dt=0.0099
step91: |x|=0.8592, |v|=0.4534, dt=0.0104
step92: |x|=0.8610, |v|=0.4530, dt=0.0109
step93: |x|=0.8628, |v|=0.4526, dt=0.0117
step94: |x|=0.8648, |v|=0.4521, dt=0.0126
step95: |x|=0.8670, |v|=0.4516, dt=0.0138
step96: |x|=0.8694, |v|=0.4510, dt=0.0157
step97: |x|=0.8722, |v|=0.4504, dt=0.0186
step98: |x|=0.8755, |v|=0.4497, dt=0.0247
step99: |x|=0.8800, |v|=0.4488, dt=0.0804
``` 
