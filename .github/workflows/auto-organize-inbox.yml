name: Auto Organize Inbox

on:
  schedule: [{ cron: "0 6 * * *" }]  # 每天早上6点
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write
  pull-requests: read

jobs:
  organize-inbox:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Auto Organize Inbox
        run: |
          set -e  # 遇到错误时退出
          echo "Starting auto-organize inbox..."
          
          # 获取当前日期和周次信息
          current_date=$(date '+%Y-%m-%d')
          current_year=$(date '+%Y')
          current_week=$(date '+%V')  # ISO周次
          
          echo "Current date: $current_date"
          echo "Current week: $current_week"
          
          # 创建周目录（如果不存在）
          week_dir="00-inbox/week-${current_week:0:2}"
          mkdir -p "$week_dir"
          echo "Week directory: $week_dir"
          
          # 查找收件箱中的文件
          inbox_dir="00-inbox"
          if [ ! -d "$inbox_dir" ]; then
            echo "Error: Inbox directory does not exist"
            exit 1
          fi
          
          # 处理收件箱中的文件
          processed_count=0
          for file in "$inbox_dir"/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "Processing file: $filename"
              
              # 跳过README.md和周次目录
              if [ "$filename" = "README.md" ] || [[ "$filename" =~ ^week-[0-9]+$ ]]; then
                echo "  Skipping README.md and week directories"
                continue
              fi
              
              # 跳过已经在周次目录中的文件
              if [[ "$filename" =~ ^\[[0-9]{6}-[0-9]{4}\].*\.md$ ]]; then
                echo "  Skipping already organized file: $filename"
                continue
              fi
              
              # 获取文件创建时间
              if [[ "$OSTYPE" == "darwin"* ]]; then
                # macOS
                create_time=$(stat -f "%SB" "$file" | date -f "%b %d %H:%M:%S %Y %z" "+%y%m%d-%H%M" 2>/dev/null || echo "")
              else
                # Linux/Windows
                create_time=$(stat -c "%y" "$file" | cut -d' ' -f1,2 | date -d "$(cat)" "+%y%m%d-%H%M" 2>/dev/null || echo "")
              fi
              
              # 如果无法获取创建时间，使用当前时间
              if [ -z "$create_time" ]; then
                create_time=$(date '+%y%m%d-%H%M')
                echo "  Warning: Cannot get creation time, using current time: $create_time"
              fi
              
              # 提取主题（去掉.md扩展名）
              topic=$(echo "$filename" | sed 's/\.md$//')
              
              # 生成新文件名
              new_filename="[${create_time}]${topic}.md"
              new_filepath="$week_dir/$new_filename"
              
              echo "  Original filename: $filename"
              echo "  Topic: $topic"
              echo "  Time: $create_time"
              echo "  New filename: $new_filename"
              
              # 移动文件到周目录
              if mv "$file" "$new_filepath"; then
                echo "  Success: File moved to $new_filepath"
                ((processed_count++))
              else
                echo "  Error: File move failed"
                exit 1
              fi
              
              echo ""
            fi
          done
          
          echo "Organization complete:"
          echo "  - Files processed: $processed_count"
          echo "  - Target directory: $week_dir"
          
          # 检查是否有变更
          if [ $processed_count -gt 0 ]; then
            echo "Changes detected, preparing to commit..."
          else
            echo "No files need organization"
          fi
          
          echo "Auto-organize step completed successfully"
      
      - name: Check for changes
        id: check_changes
        run: |
          echo "Checking for changes..."
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          fi
          echo "Change check completed"
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "Committing organization results..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Auto-organize inbox: move files to week-$current_week [skip ci]"
          git push
          echo "Organization results pushed"
      
      - name: No changes message
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo "No changes to commit"
      
      - name: Summary
        run: |
          echo ""
          echo "Inbox auto-organization complete!"
          echo "Date: $current_date"
          echo "Week: $current_week"
          echo "Directory: week-${current_week:0:2}"
          echo "Files processed: $processed_count"
          echo ""
          echo "Files have been organized to $week_dir directory"
