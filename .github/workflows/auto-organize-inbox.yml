name: Auto Organize Inbox

on:
  schedule: [{ cron: "0 6 * * *" }]  # æ¯å¤©æ—©ä¸Š6ç‚¹
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  organize-inbox:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Auto Organize Inbox
        run: |
          echo "ğŸ”„ å¼€å§‹è‡ªåŠ¨æ•´ç†æ”¶ä»¶ç®±..."
          
          # è·å–å½“å‰æ—¥æœŸå’Œå‘¨æ¬¡ä¿¡æ¯
          current_date=$(date '+%Y-%m-%d')
          current_year=$(date '+%Y')
          current_week=$(date '+%V')  # ISOå‘¨æ¬¡
          
          echo "ğŸ“… å½“å‰æ—¥æœŸ: $current_date"
          echo "ğŸ“Š å½“å‰å‘¨æ¬¡: $current_week"
          
          # åˆ›å»ºå‘¨ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          week_dir="00-inbox/week-${current_week:0:2}"
          mkdir -p "$week_dir"
          echo "ğŸ“ å‘¨ç›®å½•: $week_dir"
          
          # æŸ¥æ‰¾æ”¶ä»¶ç®±ä¸­çš„æ–‡ä»¶
          inbox_dir="00-inbox"
          if [ ! -d "$inbox_dir" ]; then
            echo "âŒ æ”¶ä»¶ç®±ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          # å¤„ç†æ”¶ä»¶ç®±ä¸­çš„æ–‡ä»¶
          processed_count=0
          for file in "$inbox_dir"/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "ğŸ“„ å¤„ç†æ–‡ä»¶: $filename"
              
              # è·³è¿‡README.mdå’Œå‘¨æ¬¡ç›®å½•
              if [ "$filename" = "README.md" ] || [[ "$filename" =~ ^week-[0-9]+$ ]]; then
                echo "   â­ï¸  è·³è¿‡README.mdå’Œå‘¨æ¬¡ç›®å½•"
                continue
              fi
              
              # è·³è¿‡å·²ç»åœ¨å‘¨æ¬¡ç›®å½•ä¸­çš„æ–‡ä»¶
              if [[ "$filename" =~ ^\[[0-9]{6}-[0-9]{4}\].*\.md$ ]]; then
                echo "   â­ï¸  è·³è¿‡å·²æ•´ç†çš„æ–‡ä»¶: $filename"
                continue
              fi
              
              # è·å–æ–‡ä»¶åˆ›å»ºæ—¶é—´
              if [[ "$OSTYPE" == "darwin"* ]]; then
                # macOS
                create_time=$(stat -f "%SB" "$file" | date -f "%b %d %H:%M:%S %Y %z" "+%y%m%d-%H%M" 2>/dev/null || echo "")
              else
                # Linux/Windows
                create_time=$(stat -c "%y" "$file" | cut -d' ' -f1,2 | date -d "$(cat)" "+%y%m%d-%H%M" 2>/dev/null || echo "")
              fi
              
              # å¦‚æœæ— æ³•è·å–åˆ›å»ºæ—¶é—´ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
              if [ -z "$create_time" ]; then
                create_time=$(date '+%y%m%d-%H%M')
                echo "   âš ï¸  æ— æ³•è·å–åˆ›å»ºæ—¶é—´ï¼Œä½¿ç”¨å½“å‰æ—¶é—´: $create_time"
              fi
              
              # æå–ä¸»é¢˜ï¼ˆå»æ‰.mdæ‰©å±•åï¼‰
              topic=$(echo "$filename" | sed 's/\.md$//')
              
              # ç”Ÿæˆæ–°æ–‡ä»¶å
              new_filename="[${create_time}]${topic}.md"
              new_filepath="$week_dir/$new_filename"
              
              echo "   ğŸ“  åŸæ–‡ä»¶å: $filename"
              echo "   ğŸ·ï¸  ä¸»é¢˜: $topic"
              echo "   ğŸ•  æ—¶é—´: $create_time"
              echo "   âœ¨  æ–°æ–‡ä»¶å: $new_filename"
              
              # ç§»åŠ¨æ–‡ä»¶åˆ°å‘¨ç›®å½•
              if mv "$file" "$new_filepath"; then
                echo "   âœ…  æ–‡ä»¶å·²ç§»åŠ¨åˆ°: $new_filepath"
                ((processed_count++))
              else
                echo "   âŒ  æ–‡ä»¶ç§»åŠ¨å¤±è´¥"
              fi
              
              echo ""
            fi
          done
          
          echo "ğŸ“Š æ•´ç†å®Œæˆç»Ÿè®¡:"
          echo "   - å¤„ç†æ–‡ä»¶æ•°: $processed_count"
          echo "   - ç›®æ ‡ç›®å½•: $week_dir"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if [ $processed_count -gt 0 ]; then
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          else
            echo "â„¹ï¸  æ²¡æœ‰æ–‡ä»¶éœ€è¦æ•´ç†"
          fi
      
      - name: Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… æ— éœ€æäº¤å˜æ›´"
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ“¤ æäº¤æ•´ç†ç»“æœ..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "ğŸ”„ Auto-organize inbox: move files to week-$current_week [skip ci]"
          git push
          echo "âœ… æ•´ç†ç»“æœå·²æ¨é€"
      
      - name: No changes message
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo "â„¹ï¸  æ— éœ€æäº¤å˜æ›´"
      
      - name: Summary
        run: |
          echo ""
          echo "ğŸ‰ æ”¶ä»¶ç®±è‡ªåŠ¨æ•´ç†å®Œæˆï¼"
          echo "ğŸ“… æ—¥æœŸ: $current_date"
          echo "ğŸ“Š å‘¨æ¬¡: $current_week"
          echo "ğŸ“ ç›®å½•: week-${current_week:0:2}"
          echo "ğŸ“„ å¤„ç†æ–‡ä»¶: $processed_count"
          echo ""
          echo "ğŸ’¡ æç¤º: æ–‡ä»¶å·²æŒ‰å‘¨æ¬¡æ•´ç†åˆ° $week_dir ç›®å½•"
