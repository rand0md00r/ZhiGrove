name: Auto Organize Inbox

on:
  schedule:
    # GitHub Actions 使用 UTC。北京时间(UTC+8) 00:00 == UTC 16:00 当天
    - cron: "0 16 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

# 仅影响步骤里的本地时间显示，不影响触发时区
env:
  TZ: Asia/Shanghai
  INBOX_DIR: docs/00-inbox

concurrency:
  group: auto-organize-inbox
  cancel-in-progress: false

jobs:
  organize-inbox:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Debug times (UTC vs Asia/Shanghai)
        run: |
          echo "UTC now:     $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
          echo "Beijing now: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')"

      - name: Get current week (Beijing local midnight)
        id: week_info
        run: |
          export TZ=Asia/Shanghai
          current_week=$(date '+%V')
          current_date=$(date '+%Y-%m-%d %H:%M:%S')
          echo "week_number=$current_week" >> $GITHUB_OUTPUT
          echo "current_date=$current_date" >> $GITHUB_OUTPUT
          echo "Week: $current_week | Beijing date: $current_date"

      - name: Create week directory
        run: |
          week_dir="${INBOX_DIR}/week-${{ steps.week_info.outputs.week_number }}"
          mkdir -p "$week_dir"
          echo "Created directory: $week_dir"

      - name: List inbox files
        run: |
          echo "Files in inbox directory:"
          ls -la "$INBOX_DIR" || true

      - name: Process files with Python (Asia/Shanghai)
        env:
          WEEK_NUMBER: ${{ steps.week_info.outputs.week_number }}
          INBOX_DIR: ${{ env.INBOX_DIR }}
        run: |
          python - <<'PY'
          import os, shutil, re
          from pathlib import Path
          from datetime import datetime
          try:
              # Python 3.9+ 时区支持
              from zoneinfo import ZoneInfo  # PEP 615
              CN = ZoneInfo("Asia/Shanghai")
          except Exception:
              CN = None

          def now_cn():
              if CN is not None:
                  return datetime.now(CN)
              # 兜底：尊重环境变量 TZ=Asia/Shanghai（不如 zoneinfo 稳妥）
              return datetime.now()

          # 统一使用上一步算出来的周号，确保跨日无不一致
          wk = os.getenv("WEEK_NUMBER")
          current_week = int(wk) if wk else now_cn().isocalendar()[1]
          inbox_dir = Path(os.getenv("INBOX_DIR", "00-inbox"))
          inbox_dir.mkdir(parents=True, exist_ok=True)
          week_dir = inbox_dir / f"week-{current_week:02d}"
          week_dir.mkdir(parents=True, exist_ok=True)

          print(f"Processing files for ISO week {current_week}")
          print("Current Beijing time:", now_cn().strftime("%Y-%m-%d %H:%M:%S %z"))
          print("Inbox directory:", inbox_dir)

          def extract_time_from_content(p: Path):
              try:
                  txt = p.read_text(encoding="utf-8", errors="ignore")
              except Exception as e:
                  print(f"    Warning: read fail: {e}")
                  return None
              patterns = [
                  r'date:\s*(\d{4}-\d{2}-\d{2})',        # YAML
                  r'创建时间[：:]\s*(\d{4}-\d{2}-\d{2})',
                  r'创建于[：:]\s*(\d{4}-\d{2}-\d{2})',
                  r'(\d{4}-\d{2}-\d{2})',
              ]
              for pat in patterns:
                  m = re.search(pat, txt)
                  if m:
                      d = m.group(1)
                      try:
                          base = datetime.strptime(d, "%Y-%m-%d")
                          n = now_cn()
                          # 用当天触发时的时分，避免无时分信息时全为 00:00
                          dt = base.replace(hour=n.hour, minute=n.minute)
                          return dt if CN is None else dt.replace(tzinfo=CN)
                      except ValueError:
                          pass
              return None

          def pick_time(p: Path):
              t = extract_time_from_content(p)
              if t:
                  print("    Using content date:", t)
                  return t
              try:
                  stat = p.stat()
                  # 以修改时间为兜底，更可移植
                  t = datetime.fromtimestamp(stat.st_mtime)
                  if CN is not None:
                      t = t.astimezone(CN)
                  print("    Using file mtime:", t)
                  return t
              except Exception as e:
                  n = now_cn()
                  print("    Fallback to now:", n, "| err:", e)
                  return n

          processed = 0
          for fp in inbox_dir.glob("*.md"):
              if fp.name in {"README.md"}: 
                  print("Skip:", fp.name); continue
              if fp.name.startswith("week-"): 
                  print("Skip week file:", fp.name); continue
              if fp.name.startswith("[") and "]." in fp.name:
                  print("Skip organized:", fp.name); continue

              print("Processing:", fp.name)
              dt = pick_time(fp)
              time_str = dt.strftime("%y%m%d-%H%M")
              new_name = f"[{time_str}]{fp.stem}.md"
              dest = week_dir / new_name
              try:
                  shutil.move(str(fp), dest)
                  print("  Moved ->", dest)
                  processed += 1
              except Exception as e:
                  print("  Move error:", e)

          print("Total files processed:", processed)
          PY

      - name: Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Auto-organize inbox: week-${{ steps.week_info.outputs.week_number }} [skip ci]"
          git push

      - name: Summary
        run: |
          echo "Inbox auto-organization complete!"
          echo "Week: ${{ steps.week_info.outputs.week_number }}"
          echo "Beijing date (at run): ${{ steps.week_info.outputs.current_date }}"
          echo "Directory: ${INBOX_DIR}/week-${{ steps.week_info.outputs.week_number }}"
