name: Auto Organize Inbox

on:
  schedule: [{ cron: "0 6 * * *" }]  # 每天早上6点（北京时间）
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write
  pull-requests: read

env:
  TZ: Asia/Shanghai

jobs:
  organize-inbox:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Get current week (Beijing time)
        id: week_info
        run: |
          # 设置时区为北京时间
          export TZ=Asia/Shanghai
          current_week=$(date '+%V')
          current_date=$(date '+%Y-%m-%d %H:%M:%S')
          echo "week_number=$current_week" >> $GITHUB_OUTPUT
          echo "current_date=$current_date" >> $GITHUB_OUTPUT
          echo "Current week: $current_week"
          echo "Current date (Beijing): $current_date"
      
      - name: Create week directory
        run: |
          week_dir="00-inbox/week-${{ steps.week_info.outputs.week_number }}"
          mkdir -p "$week_dir"
          echo "Created directory: $week_dir"
      
      - name: List inbox files
        run: |
          echo "Files in inbox directory:"
          ls -la 00-inbox/
      
      - name: Process files with Python
        run: |
          python -c "
          import os
          import shutil
          import datetime
          from pathlib import Path
          
          # Set timezone to Beijing time
          os.environ['TZ'] = 'Asia/Shanghai'
          
          # Get current week (Beijing time)
          current_week = datetime.datetime.now().isocalendar()[1]
          week_dir = f'00-inbox/week-{current_week:02d}'
          
          print(f'Processing files for week {current_week}')
          print(f'Target directory: {week_dir}')
          print(f'Current time (Beijing): {datetime.datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}')
          
          # Process files
          inbox_dir = '00-inbox'
          processed_count = 0
          
          for file_path in Path(inbox_dir).glob('*.md'):
              if file_path.name == 'README.md':
                  print(f'Skipping README.md')
                  continue
                  
              if file_path.name.startswith('week-'):
                  print(f'Skipping week directory: {file_path.name}')
                  continue
                  
              if file_path.name.startswith('[') and '].' in file_path.name:
                  print(f'Skipping already organized file: {file_path.name}')
                  continue
              
              print(f'Processing: {file_path.name}')
              
              # Get file creation time (preferred) or modification time
              try:
                  stat = file_path.stat()
                  # Try to get creation time, fallback to modification time
                  if hasattr(stat, 'st_birthtime'):  # macOS
                      create_time = stat.st_birthtime
                  elif hasattr(stat, 'st_ctime'):   # Linux/Windows
                      create_time = stat.st_ctime
                  else:
                      create_time = stat.st_mtime
                  
                  # Convert to Beijing time
                  dt = datetime.datetime.fromtimestamp(create_time)
                  # Format as YYMMDD-HHMM
                  time_str = dt.strftime('%y%m%d-%H%M')
                  print(f'  File creation time: {dt.strftime(\"%Y-%m-%d %H:%M:%S\")}')
                  print(f'  Formatted time: {time_str}')
                  
              except Exception as e:
                  print(f'  Warning: Cannot get file time: {e}')
                  # Use current time as fallback
                  dt = datetime.datetime.now()
                  time_str = dt.strftime('%y%m%d-%H%M')
                  print(f'  Using current time: {time_str}')
              
              # Generate new filename
              topic = file_path.stem
              new_filename = f'[{time_str}]{topic}.md'
              new_filepath = Path(week_dir) / new_filename
              
              print(f'  New filename: {new_filename}')
              
              # Move file
              try:
                  shutil.move(str(file_path), str(new_filepath))
                  print(f'  Success: Moved to {new_filepath}')
                  processed_count += 1
              except Exception as e:
                  print(f'  Error moving {file_path.name}: {e}')
          
          print(f'Total files processed: {processed_count}')
          "
      
      - name: Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Auto-organize inbox: move files to week-${{ steps.week_info.outputs.week_number }} [skip ci]"
          git push
          echo "Changes committed and pushed"
      
      - name: No changes message
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo "No changes to commit"
      
      - name: Summary
        run: |
          echo "Inbox auto-organization complete!"
          echo "Week: ${{ steps.week_info.outputs.week_number }}"
          echo "Date (Beijing): ${{ steps.week_info.outputs.current_date }}"
          echo "Directory: 00-inbox/week-${{ steps.week_info.outputs.week_number }}"
