name: Auto Organize Inbox

on:
  schedule: [{ cron: "0 6 * * *" }]  # 每天早上6点
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write
  pull-requests: read

jobs:
  organize-inbox:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Get current week
        id: week_info
        run: |
          current_week=$(date '+%V')
          echo "week_number=$current_week" >> $GITHUB_OUTPUT
          echo "Current week: $current_week"
      
      - name: Create week directory
        run: |
          week_dir="00-inbox/week-${{ steps.week_info.outputs.week_number }}"
          mkdir -p "$week_dir"
          echo "Created directory: $week_dir"
      
      - name: List inbox files
        run: |
          echo "Files in inbox directory:"
          ls -la 00-inbox/
      
      - name: Process files with Python
        run: |
          python -c "
          import os
          import shutil
          import datetime
          from pathlib import Path
          
          # Get current week
          current_week = datetime.datetime.now().isocalendar()[1]
          week_dir = f'00-inbox/week-{current_week:02d}'
          
          print(f'Processing files for week {current_week}')
          print(f'Target directory: {week_dir}')
          
          # Process files
          inbox_dir = '00-inbox'
          processed_count = 0
          
          for file_path in Path(inbox_dir).glob('*.md'):
              if file_path.name == 'README.md':
                  print(f'Skipping README.md')
                  continue
                  
              if file_path.name.startswith('week-'):
                  print(f'Skipping week directory: {file_path.name}')
                  continue
                  
              if file_path.name.startswith('[') and '].' in file_path.name:
                  print(f'Skipping already organized file: {file_path.name}')
                  continue
              
              # Get creation time
              try:
                  stat = file_path.stat()
                  create_time = datetime.datetime.fromtimestamp(stat.st_ctime).strftime('%y%m%d-%H%M')
              except:
                  create_time = datetime.datetime.now().strftime('%y%m%d-%H%M')
              
              # Generate new filename
              topic = file_path.stem
              new_filename = f'[{create_time}]{topic}.md'
              new_filepath = Path(week_dir) / new_filename
              
              print(f'Processing: {file_path.name} -> {new_filename}')
              
              # Move file
              try:
                  shutil.move(str(file_path), str(new_filepath))
                  print(f'Success: Moved to {new_filepath}')
                  processed_count += 1
              except Exception as e:
                  print(f'Error moving {file_path.name}: {e}')
          
          print(f'Total files processed: {processed_count}')
          "
      
      - name: Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Auto-organize inbox: move files to week-${{ steps.week_info.outputs.week_number }} [skip ci]"
          git push
          echo "Changes committed and pushed"
      
      - name: No changes message
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo "No changes to commit"
      
      - name: Summary
        run: |
          echo "Inbox auto-organization complete!"
          echo "Week: ${{ steps.week_info.outputs.week_number }}"
          echo "Directory: 00-inbox/week-${{ steps.week_info.outputs.week_number }}"
